{header}

<body>
  <div class="loadpage">
    <div class="content_loadpage">
     <div class="logox">
        <a href="/ncc/dashboard"><img src="{logo}" alt="logo" class="ncc-logo-mobile"></a>
      </div>
      <div class="loadx"></div>
    </div>
  </div>
  <div class="page_body">
    <div class="logo_mobile">
      <a href="/ncc/dashboard"><img src="{logo}" alt="logo" class="ncc-logo-mobile"></a>
      <div class="slogan"><a href="/">Đơn vị tiên phong về TMĐT hàng hóa chính hãng</a></div>
    </div>

    <!-- Box cao nhất _ toptop -->
    <div class="menu_top">
      <div class="menu_top_left">
        <div class="drop_down">
          <button><i class="icon icon-list"></i> MENU</button>
          <div class="drop_menu scroll">
            {box_menu}
          </div>
        </div>
        <div class="title_action" style="width: 170px;"><i class="fa fa-th"></i> {title_action}</div>
      </div>


      <div class="menu_top_center" style="margin-left: 25%;">
        <div class="social_box"
          style="margin-left: 15px;border: 1px solid rgb(147, 141, 140); padding: 3px 5px; border-radius: 20px; background-color: rgb(42, 68, 231);">
          <svg xmlns="http://www.w3.org/2000/svg" x="0px" y="0px" width="25" height="20" viewBox="0 0 48 48">
            <linearGradient id="Ld6sqrtcxMyckEl6xeDdMa_uLWV5A9vXIPu_gr1" x1="9.993" x2="40.615" y1="9.993" y2="40.615"
              gradientUnits="userSpaceOnUse">
              <stop offset="0" stop-color="#2aa4f4"></stop>
              <stop offset="1" stop-color="#007ad9"></stop>
            </linearGradient>
            <path fill="url(#Ld6sqrtcxMyckEl6xeDdMa_uLWV5A9vXIPu_gr1)"
              d="M24,4C12.954,4,4,12.954,4,24s8.954,20,20,20s20-8.954,20-20S35.046,4,24,4z"></path>
            <path fill="#fff"
              d="M26.707,29.301h5.176l0.813-5.258h-5.989v-2.874c0-2.184,0.714-4.121,2.757-4.121h3.283V12.46 c-0.577-0.078-1.797-0.248-4.102-0.248c-4.814,0-7.636,2.542-7.636,8.334v3.498H16.06v5.258h4.948v14.452 C21.988,43.9,22.981,44,24,44c0.921,0,1.82-0.084,2.707-0.204V29.301z">
            </path>
          </svg>
          <!-- <i style="color: #ffffff;" class="fa fa-facebook"></i> -->
          <span> <a href="https://www.facebook.com/groups/nguonhangsocdo" style="color: aliceblue;"
              target="_blank">Group</a></span>
        </div>
        <div class="social_box"
          style="border: 1px solid rgb(147, 141, 140); padding: 3px 5px; border-radius: 20px; background-color:  rgb(42, 68, 231);">
          <svg xmlns="http://www.w3.org/2000/svg" x="0px" y="0px" width="25" height="20" viewBox="0 0 48 48">
            <linearGradient id="Ld6sqrtcxMyckEl6xeDdMa_uLWV5A9vXIPu_gr1" x1="9.993" x2="40.615" y1="9.993" y2="40.615"
              gradientUnits="userSpaceOnUse">
              <stop offset="0" stop-color="#2aa4f4"></stop>
              <stop offset="1" stop-color="#007ad9"></stop>
            </linearGradient>
            <path fill="url(#Ld6sqrtcxMyckEl6xeDdMa_uLWV5A9vXIPu_gr1)"
              d="M24,4C12.954,4,4,12.954,4,24s8.954,20,20,20s20-8.954,20-20S35.046,4,24,4z"></path>
            <path fill="#fff"
              d="M26.707,29.301h5.176l0.813-5.258h-5.989v-2.874c0-2.184,0.714-4.121,2.757-4.121h3.283V12.46 c-0.577-0.078-1.797-0.248-4.102-0.248c-4.814,0-7.636,2.542-7.636,8.334v3.498H16.06v5.258h4.948v14.452 C21.988,43.9,22.981,44,24,44c0.921,0,1.82-0.084,2.707-0.204V29.301z">
            </path>
          </svg>
          <!-- <i style="color: rgb(255, 255, 255);" class="fa fa-facebook"></i> -->
          <span> <a href="https://www.facebook.com/SocDoPage" style="color: aliceblue;"
              target="_blank">Fanpage</a></span>
        </div>
      </div>
      <div class="menu_top_right">
        <div class="notification">
          <div class="icon_notification">
            <i style="border: 2px solid rgb(234, 141, 141); border-radius: 6px;" class="fa fa-bell">
              <span class="total_notification">0</span>
            </i>
          </div>
          <div class="list_notification">
            <div class="tab_notification">
              <div class="li_tab" id="tab_all">Tất cả</div>
              <div class="li_tab active" id="tab_chuadoc">Chưa đọc</div>
              <div class="li_tab active" id=""><a style="color: #ffffff !important;" href="/ncc/list-thongbao">Thông báo
                  mới</a><span style="color: #333;margin-left:4px;" class="total_thongbao">0</span></div>
              <!-- <div class="li_tab active" id=""><a style="color: #ffffff !important;"
                  href="/ncc/list-sanpham-tuan">Chương trình tuần</a><span style="color: #333;margin-left:4px;"
                  class="total_ct_tuan">0</span></div>
              <div class="li_tab active" id=""> <a style="color: #ffffff !important;"
                  href="/ncc/list-sanpham-hethang-catma">Sắp cắt mã</a><span style="color: #333;margin-left:4px;"
                  class="total_catma">0</span></div>
              <div class="li_tab active" id=""><a style="color: #ffffff !important;"
                  href="/ncc/list-sanpham-hethang">Sắp hết hàng</a><span style="color: #333;margin-left:4px;"
                  class="total_hethang">0</span></div> -->
            </div>
            <div class="list_noti scroll" scroll page="1" tiep='1' loaded="1">
              <div class="loading_notification">
                <i class="fa fa-refresh fa-spin"></i> Đang tải dữ liệu...
              </div>
            </div>
          </div>
        </div>

        <div class="chat_ncc_btn"
          style="display:inline-block; margin-left: 15px; cursor:pointer; position:relative;margin-right: 15px;">
          <i class="fa fa-comments" style="font-size: 22px; color: #4caaff;"></i>
          <span class="total_chat_unread"
            style="position:absolute;top:-6px;right:-8px;background:#e74c3c;color:#fff;font-size:12px;padding:1px 6px;border-radius:10px;display:none;">0</span>
        </div>


        <!-- <div style="margin-left: 5px;" class="avatar hide_mobile">
          <a href="/ncc/list-sanpham-follow">
            <img src=""
              style="width: 26px;height:26px;margin-top: 4px; margin-right: 5px;border: 2px solid rgb(234, 141, 141);"
              alt="avatar" onerror="this.src='/images/favourite.png';">
            <span class="total_quantam">{total_follow}</span>
          </a>
        </div> -->


        <div class="drop_down">
          <button class="user-btn" data-fullname="{fullname}">
            <span class="user-fullname">{fullname}</span>
            <i class="fa fa-angle-down ml-1"></i>
          </button>
          <div class="drop_menu" style="width: 200px;">
            <div class="drop_item"><b>{fullname}</b>
              <div class="text_muted">{email}</div>
            </div>
            <div class="line"></div>
            <a class="drop_item" href="/ncc/profile"><i class="icon icon-profile"></i> Profile</a>
            <div class="line"></div>
            <a class="drop_item text_danger" href="/ncc/logout"><i class="mr-3 icon icon-switch"></i> Đăng xuất</a>
          </div>
        </div>

        <div class="avatar hide_mobile"><a href="/ncc/profile"><img style="border: 2px solid rgb(234, 141, 141);"
              src="{avatar}" alt="avatar" onerror="this.src='/images/user.png';"></a>
        </div>
        <!-- <div class="avatar hide_mobile box_shopcart">
          <a href="/ncc/add-donhang-drop?step=2">
            <img src="" style="border: 2px solid rgb(234, 141, 141);" alt="avatar"
              onerror="this.src='/images/cart.png';">
            <span class="cart-count">{total_cart}</span>
          </a>
        </div> -->

      </div>
    </div>
    <!-- Box cao nhất _ toptop -->

    <!-- mới  -->
    <div id="popup_overlay"></div>
    <!-- mới  -->




    <!-- <div class="list_donhang_top">
      <div class="swiper-container slide_donhang">
        <div class="swiper-wrapper">{list_donhang_slide}
          {marquee}
        </div>
      </div>
    </div> -->
    <div class="box_left">
      <div class="box_menu_left scroll">
        <div class="logo">
          <a href="/ncc/dashboard"><img src="{logo}" alt="logo"></a>

          
        </div>
        <div class="box_left_content">
          <!-- đây là menu trái  -->
          {box_menu}
          <!-- đây là menu trái  -->
          <div class="hr"></div>
          <div class="menu_text_center">Administrator Panel</div>
        </div>
      </div>
    </div>
    <!-- Nội dung trang chính ở đâyđây -->
    {box_right}
    <!-- Nội dung trang chính ở đâyđây -->
  </div>
  {box_script_footer}

  <div id="popup_overlay"></div>


  <div id="popup_lo_trinh">
    <div class="popup_content">
      <!-- tầng 1  -->
      <div class="section_box_top">
        <div class="luu_y" style="border: 2px red dotted; border-radius: 20px;">
          <h2>Có thể bạn chưa biết ❓</h2>
          <ul>
            <li><a href="#" class="trigger_small_popup" data-target="popup_afilate"><b>"Afilate"</b> là gì ?</a></li>
            <li><a href="#" class="trigger_small_popup" data-target="popup_template"><b>"Template"</b> là gì ?</a></li>
            <li><a href="#" class="trigger_small_popup" data-target="popup_banhang1cham">Bán hàng 1 chạm như thế nào
                ?</a></li>
            <li><a href="#" class="trigger_small_popup" data-target="popup_congthuc">Công thức tính <b>"hoa hồng</b>,
                <b>thưởng"</b> ? <i class="fa fa-star-o"></i></a></li>
          </ul>
          <!-- <i style="float:right;margin: 0 5px 5px 0;"><a href="" style=" color: #333;">Chi tiết >></a></i> -->
        </div>

        <div class="text_top">
          <div class="content" style="margin-left: 35px;">
            <div class="inner" style="display: flex;">
              <p>Xây dựng - Phát triển thương hiệu cá nhân</p>
              <p>Bán hàng 1 chạm<br> siêu dễ dàng</p>
            </div>

            <div class="social_media_top" style="text-align: center;">
              <div>
                <img src="/images/zalo.png" alt="Zalo">
                <img src="/images/insta.png" alt="Instagram">
                <img src="/images/facebook.png" alt="Facebook">
              </div>

            </div>
            <h3 style="position: relative;"> <a href="/ncc/nhiemvu-nguoimoi">Bán hàng bằng nhân
                hiệu các nhân</a>
              <div class="line1 line_top1"></div>
              <div class="line1 line_top2"></div>
              <div class="line1 line_top3"></div>
            </h3>

          </div>
        </div>

        <div class="banner_img">
          <img src="/images/nen_timhieu-Photoroom.png" style="width: 80%;" alt="Banner lộ trình">
        </div>
      </div>
      <!-- tầng 22  -->
      <div class="section_box_mid">

        <div class="box-two flex-row" style="position: relative;">
          <p>Hoa hồng liên kết <strong>200.000</strong>vnđ/User<i class="user_icon"></i></p>
          <p>Thưởng <strong>5%</strong> hoa hồng nhóm Nhà bán</p>

          <p>Thưởng <strong>1.5 triệu</strong> cho Nhà Bán lên NBCN</p>
          <p>Thưởng <strong>1.5%</strong> nhóm nhà bán CN <i class="fa fa-users"></i></p>
          <div class="line2 line_mid_left1"></div>
          <div class="line2 line_mid_left2"></div>
          <div class="line2 line_mid_left3"></div>
          <div class="line2 line_mid_left4"></div>
        </div>
        <h3>
          <a href="#" class="trigger_small_popup" data-target="popup_suckien">Sự nghiệp trọn đời : Nhà bán hàng Chuyên
            Nghiệp</a>

        </h3>

        <div class="trung-tam">
          <h4>Nhà bán hàng
            <img src="/images/socdo.png" alt="socdo.vn">
          </h4>
          <span class="arrow arrow-right">&rarr;</span>
          <span class="arrow arrow-down">&darr;</span>
          <span class="arrow arrow-up">&uarr;</span>
          <span class="arrow arrow-left">&larr;</span>

        </div>

        <h3>
          <a href="#" class="trigger_small_popup" data-target="popup_bansan">Bán hàng trên sàn thương mại điện tử</a>

        </h3>
        <div class="box-one flex-row" style="display: flex;">
          <div class="social_media_mid">
            <div class="box_social" style="position: relative;">
              <img src="/images/lazada.png" alt="Lazada">
              <img src="/images/shoppee.png" alt="Shopee">
              <img src="/images/tiktok.png" alt="TikTok">
              <div class="line3 line_mid_right1"></div>
              <div class="line3 line_mid_right2"></div>
              <div class="line3 line_mid_right3"></div>
              <div class="line3 line_mid_right4"></div>
              <div class="line3 line_mid_right5"></div>
              <div class="line3 line_mid_right6"></div>
              <div class="line3 line_mid_right7"></div>
              <div class="line3 line_mid_right8"></div>
              <div class="line3 line_mid_right9"></div>


            </div>
          </div>
          <div class="text-mid-3">
            <p><a href="/ncc/list-dichvu#bo-template">Cung cấp Template chuyên nghiệp <i class="fa fa-cog"></i>
              </a></p>
            <p><a href="/ncc/list-dichvu#setup-gian-hang">Setup <i class="fa fa-cog"></i>
                gian hàng <br> chuyên nghiệp</a></p>
            <p><a href="/ncc/list-dichvu#coppy-san-pham">Sao chép và trang trí sản phẩm</a></p>
            <p><strong><a href="/ncc/list-dichvu#seeding-shopee">Wow Seeding</a> <br></strong>🗣️</p>
            <p><a href="/ncc/list-idol">🎬 Book lịch <br>
                LiveStream</a></p>

          </div>

        </div>
      </div>

      <!-- tầng 3  -->
      <div class="section_box_bottom">
        <div class="box1">
        </div>
        <div class="box_2">
          <p><a href="/ncc/domain">Tích hợp <br><strong>tên miền</strong> riêng</a></p>
          <h3><a href="/ncc/list-giaodien">Bán hàng qua<br> Website chuyên nghiệp</a></h3>
          <p><a href="/ncc/list-giaodien">Mẫu<strong>Template</strong><br>hiện đại</a><i class="user_icon"></i>
          </p>
        </div>
        <div class="box_3">
          <p> <a href="">Kênh maketting đầy <br> đủ tính năng</a></p>
          <p> <a href="/ncc/add-sanpham-ngoai">Tự kinh doanh <br>sản phẩm riêng</a></p>
          <p><a href="">Dễ dàng làm <strong>Afillate</strong> <br> đa nền tảng</a></p>
        </div>
        <div class="line4 line_bottom1"></div>
        <div class="line4 line_bottom2"></div>
        <div class="line4 line_bottom3"></div>
        <div class="line4 line_bottom4"></div>

        <div class="banner_img" style="width: 260px;height: 130px;position: absolute; top:20px;left: 20px;">
          <img src="/images/z6354740174903_358754b37bcb429683664387f6d37455.jpg" style="height:100%;width:128%;"
            alt="Banner lộ trình">
        </div>
      </div>
    </div>




    <button class="close_popup">❌</button>
  </div>

  <!-- Small popup, ẩn ban đầu, nằm bên trong popup_lo_trinh -->
  <div class="small_popup" id="popup_afilate">
    <div class="small_popup_content">
      <button class="close_small_popup" style="background-color: #4c9af3;">❌</button>
      <h4>"Afilate" là gì ?</h4>
      <p>Nội dung chi tiết về Afilate ....</p>
    </div>
  </div>
  <div class="small_popup" id="popup_template">
    <div class="small_popup_content">
      <button class="close_small_popup" style="background-color: #4c9af3;">❌</button>
      <h4>"Template" là gì ?</h4>
      <p>Nội dung chi tiết về Template ....</p>
    </div>
  </div>
  <div class="small_popup" id="popup_banhang1cham">
    <div class="small_popup_content">
      <button class="close_small_popup" style="background-color: #4c9af3;">❌</button>
      <h4>Bán hàng 1 chạm</h4>
      <p>Nội dung chi tiết về bán hàng 1 chạm ....</p>
    </div>
  </div>
  <div class="small_popup" id="popup_congthuc">
    <div class="small_popup_content">
      <button class="close_small_popup" style="background-color: #4c9af3;">❌</button>
      <h4>Công thức tính hoa hồng, thưởng</h4>
      <p>Nội dung chi tiết về công thức tính ....</p>
    </div>
  </div>
  <div class="small_popup" id="popup_suckien">
    <div class="small_popup_content">
      <button class="close_small_popup" style="background-color: #4c9af3;">❌</button>
      <h4>Sự nghiệp trọn đời : Nhà bán hàng Chuyên Nghiệp</h4>
      <p>Nội dung chi tiết ....</p>
    </div>
  </div>
  <div class="small_popup" id="popup_bansan">
    <div class="small_popup_content">
      <button class="close_small_popup" style="background-color: #4c9af3;">❌</button>
      <h4>Bán hàng trên sàn thương mại điện tử</h4>
      <p>Nội dung chi tiết ....</p>
    </div>
  </div>

  <!-- Popup chat NCC nhỏ -->
  <div id="popup_chat_ncc" class="popup_chat_ncc"
    style="display:none; position:fixed; bottom:80px; right:40px; width:450px; max-width:95vw; background:#fff; box-shadow:0 2px 16px rgba(0,0,0,0.18); border-radius:12px; z-index:99999; overflow:hidden;">
    <div class="chat_ncc_header"
      style="background:#4caaff; color:#fff; padding:10px 16px; display:flex; align-items:center; justify-content:space-between;">
      <span><i class="fa fa-comments"></i> Chat khách hàng</span>
      <span class="close_chat_ncc" style="cursor:pointer;font-size:18px;"><i class="fa fa-times"></i></span>
    </div>
    <div class="chat_ncc_body" style="height:400px; max-height:60vh; display:flex;">
      <div class="chat_ncc_list" style="width:165px; border-right:1px solid #eee; overflow-y:auto; background:#f7f7f7;">
        <!-- Danh sách chat sẽ render ở đây -->
        <div class="loading_chat_list" style="text-align:center;padding:20px; color:#888;">Đang tải...</div>
      </div>
      <div class="chat_ncc_messages" style="flex:1; display:flex; flex-direction:column;">
        <div class="chat_ncc_msgs_scroll" style="flex:1; overflow-y:auto; padding:10px; background:#fafbfc;">
          <!-- Tin nhắn sẽ render ở đây -->
          <div class="loading_msgs" style="text-align:center;padding:20px; color:#888;">Chọn cuộc trò chuyện</div>
        </div>
        <div class="chat_ncc_input_box" style="padding:8px; border-top:1px solid #eee; background:#fff; display:flex;">
          <input type="text" class="chat_ncc_input" placeholder="Nhập tin nhắn..."
            style="flex:1; border:1px solid #ddd; border-radius:6px; padding:6px 10px; outline:none;">
          <button class="chat_ncc_send_btn"
            style="margin-left:8px; background:#4caaff; color:#fff; border:none; border-radius:6px; padding:6px 14px; cursor:pointer;"><i
              class="fa fa-paper-plane"></i></button>
        </div>
      </div>
    </div>
  </div>
  <!-- Popup chat NCC nhỏ -->
  <style>
    .user-btn {
      display: flex;
      align-items: center;
      width: 130px;
      position: relative;
      background: #fff;
      border: none;
      cursor: pointer;
    }

    .user-fullname {
      flex: 1 1 auto;
      min-width: 0;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      display: block;
    }

    /* Tooltip custom khi hover */
    .user-btn:hover::after {
      content: attr(data-fullname);
      position: absolute;
      left: 100%;
      top: 110%;
      transform: translateX(-100%);
      background: #222;
      color: #fff;
      padding: 6px 12px;
      border-radius: 4px;
      white-space: pre;
      z-index: 10;
      min-width: 120px;
      max-width: 500%;
      font-size: 14px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
      pointer-events: none;
    }
  </style>

</body>

<script>
  $(document).ready(function () {
    $('.lo_trinh_btn').on('click', function (e) {
      e.preventDefault();
      $('#popup_overlay').fadeIn();
      $('#popup_lo_trinh').fadeIn();
    });

    $('#popup_overlay, #popup_lo_trinh .close_popup').on('click', function () {
      $('#popup_overlay').fadeOut();
      $('#popup_lo_trinh').fadeOut();
    });
  });


  $(document).on('click', '.trigger_small_popup', function (e) {
    e.preventDefault();
    var targetPopup = $(this).data('target');
    $('#' + targetPopup).fadeIn();
  });

  $(document).on('click', '.close_small_popup', function (e) {
    e.preventDefault();
    $(this).closest('.small_popup').fadeOut();
  });

</script>

<div id="google_translate_element"></div>

<!-- <script src="https://chat.socdo.vn/socket.io/socket.io.js"></script> -->
</style>

<script type="text/javascript">
  var check_language = { check_language };
  if (check_language == 1) {
    $('.load_overlay').show();
    $('.load_process').fadeIn();
    $('.load_note').html('The system is processing');
    function googleTranslateElementInit() {
      new google.translate.TranslateElement({
        pageLanguage: 'vi',
        includedLanguages: 'en,vi',
        layout: google.translate.TranslateElement.InlineLayout.SIMPLE
      }, 'google_translate_element');
    }
    setTimeout(function () {
      $('.load_process').hide();
      var select = document.querySelector('select.goog-te-combo');
      if (select) {
        select.value = 'en';
        select.dispatchEvent(new Event('change'));
      }
      $('.load_overlay').hide();
      $('.load_sanpham').hide();
    }, 3000);
  }
</script>
<script src="//translate.google.com/translate_a/element.js?cb=googleTranslateElementInit"></script>
<!-- <script src="https://cdn.socket.io/4.8.1/socket.io.min.js"></script> -->



<script>
  $(document).ready(function () {
    var user_id = parseInt('{user_id}' || 0);
    var is_ncc = 1; // Đã check ở backend, chỉ NCC mới vào được
    var currentSessionId = null;
    var socket = window.io ? io('https://chat.socdo.vn', { transports: ['websocket'] }) : null;
    // Hàm cập nhật badge tổng số tin chưa đọc
    function updateTotalChatUnread() {
      $.post('/api/chat_ncc.php', { action: 'list_sessions' }, function (list) {
        var total_unread = 0;
        if (list && list.length) {
          list.forEach(function (s) {
            total_unread += s.unread_count || 0;
          });
        }
        if (total_unread) {
          $('.total_chat_unread').text(total_unread).show();
        } else {
          $('.total_chat_unread').hide();
        }
      }, 'json');
    }

    // Gọi khi trang load xong
    updateTotalChatUnread();

    // Hiện/ẩn popup chat
    $('.chat_ncc_btn').on('click', function () {
      $('#popup_chat_ncc').fadeIn(150);
      loadChatSessions();
    });
    $('.close_chat_ncc').on('click', function () {
      $('#popup_chat_ncc').fadeOut(150);
      currentSessionId = null;
      $('.chat_ncc_msgs_scroll').html('<div class="loading_msgs" style="text-align:center;padding:20px; color:#888;">Chọn cuộc trò chuyện</div>');
    });

    // Đóng popup khi click ngoài
    $(document).on('mousedown', function (e) {
      var popup = $('#popup_chat_ncc');
      if (popup.is(':visible') && !$(e.target).closest('#popup_chat_ncc,.chat_ncc_btn').length) {
        popup.fadeOut(150);
        currentSessionId = null;
      }
    });

    // Gửi tin nhắn
    $('.chat_ncc_send_btn').on('click', sendMessage);
    $('.chat_ncc_input').on('keypress', function (e) {
      if (e.which === 13) sendMessage();
    });

    function sendMessage() {
      var msg = $('.chat_ncc_input').val().trim();
      if (!msg || !currentSessionId) return;
      $('.chat_ncc_input').val('');
      $.post('/api/chat_ncc.php', {
        action: 'send_message',
        session_id: currentSessionId,
        ncc_id: user_id,
        message: msg
      }, function (res) {
        if (res.status) {
          // Gửi realtime
          if (socket) {
            socket.emit('ncc_send_message', {
              session_id: currentSessionId,
              ncc_id: user_id,
              message: msg
            });
          }
          loadMessages(currentSessionId, true);
        }
      }, 'json');
    }

    // Tải danh sách chat
    function loadChatSessions() {
      $('.chat_ncc_list').html('<div class="loading_chat_list" style="text-align:center;padding:20px; color:#888;">Đang tải...</div>');
      $.post('/api/chat_ncc.php', { action: 'list_sessions' }, function (list) {
        console.log('API list_sessions result:', list); // DEBUG
        if (!list.length) {
          $('.chat_ncc_list').html('<div style="padding:20px; color:#888;">Không có cuộc trò chuyện nào</div>');
          $('.total_chat_unread').hide();
          return;
        }
        var html = '';
        var total_unread = 0;
        list.forEach(function (s, idx) {
          var unread = s.unread_count || 0;
          total_unread += unread;
          html += '<div class="chat_ncc_item' + (currentSessionId == s.session_id ? ' active' : '') + '" data-id="' + s.session_id + '" style="padding:10px 8px;cursor:pointer;display:flex;align-items:center;' + (unread ? 'font-weight:bold;' : '') + '">';
          html += '<img src="' + (s.customer_avatar || '/images/user.png') + '" style="width:32px;height:32px;border-radius:50%;object-fit:cover;margin-right:8px;">';
          html += '<div style="flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">' + (s.customer_name || 'Khách hàng') + '</div>';
          if (unread) html += '<span style="background:#e74c3c;color:#fff;font-size:11px;padding:1px 6px;border-radius:10px;margin-left:4px;">' + unread + '</span>';
          html += '</div>';
        });
        $('.chat_ncc_list').html(html);
        if (total_unread) {
          $('.total_chat_unread').text(total_unread).show();
        } else {
          $('.total_chat_unread').hide();
        }
      }, 'json');
    }

    // Click chọn phiên chat
    $(document).on('click', '.chat_ncc_item', function () {
      var sid = $(this).data('id');
      currentSessionId = sid;
      $('.chat_ncc_item').removeClass('active');
      $(this).addClass('active');
      loadMessages(sid);
      // Đánh dấu đã đọc
      $.post('/api/chat_ncc.php', { action: 'mark_read', session_id: sid, user_type: 'ncc' });
      // Ẩn badge unread
      $(this).find('span').remove();
      $('.total_chat_unread').hide();
    });

    // Tải tin nhắn
    function loadMessages(session_id, scrollBottom) {
      $('.chat_ncc_msgs_scroll').html('<div class="loading_msgs" style="text-align:center;padding:20px; color:#888;">Đang tải...</div>');
      $.post('/api/chat_ncc.php', { action: 'get_messages', session_id: session_id }, function (msgs) {
        if (!msgs.length) {
          $('.chat_ncc_msgs_scroll').html('<div style="padding:20px; color:#888;">Chưa có tin nhắn nào</div>');
          return;
        }
        var html = '';
        msgs.forEach(function (m) {
          html += '<div style="margin-bottom:10px;display:flex;' + (m.is_me ? 'justify-content:flex-end;' : 'justify-content:flex-start;') + '">';
          html += '<div style="max-width:70%;background:' + (m.is_me ? '#555867;color:#fff;' : '#f1f1f1;') + ';padding:7px 12px;border-radius:12px;">' + m.message + '<div style="font-size:11px;color:#888;margin-top:2px;text-align:right;">' + m.time + '</div></div>';
          html += '</div>';
        });
        $('.chat_ncc_msgs_scroll').html(html);
        if (scrollBottom !== false) {
          var box = $('.chat_ncc_msgs_scroll');
          box.scrollTop(box[0].scrollHeight);
        }
      }, 'json');
    }

    // Realtime nhận tin nhắn
    if (socket) {
      socket.on('server_send_message', function (data) {
        if (data.ncc_id == user_id && data.session_id == currentSessionId) {
          loadMessages(currentSessionId, true);
        } else if (data.ncc_id == user_id) {
          if ($('#popup_chat_ncc').is(':visible')) loadChatSessions();
        }
        // Cập nhật badge realtime
        updateTotalChatUnread();
      });
    }

    // Khi mở popup, tự động reload danh sách chat mỗi 20s
    var chatListInterval = null;
    $('#popup_chat_ncc').on('show', function () {
      if (chatListInterval) clearInterval(chatListInterval);
      chatListInterval = setInterval(loadChatSessions, 20000);
    });
    $('#popup_chat_ncc').on('hide', function () {
      if (chatListInterval) clearInterval(chatListInterval);
    });

    // Khi mở popup lần đầu
    $('#popup_chat_ncc').on('fadeIn', function () {
      loadChatSessions();
    });
  });
</script>



</html>